name: Haskell CI

on:
  push:
    branches: [ "master" ]
  pull_request:

jobs:
  build:
    runs-on: ${{ matrix.sys.os }}

    strategy:
      fail-fast: false
      matrix:
        ghc: ["9.6", "9.10", "9.12"]
        cabal: ["3.14"]
        sys:
          - { os: windows-latest, shell: 'C:/msys64/usr/bin/bash.exe -e {0}' }
          - { os: ubuntu-latest, shell: bash }
        release-ghc: "9.6"
        release-tag: "4.0.1"
        include:
          # Using include, to make sure there will only be one macOS job, even if the matrix gets expanded later on.
          # We want a single job, because macOS runners are scarce.
          - cabal: "3.12"
            ghc: "9.6"
            sys:
              os: macos-latest
              shell: bash

    defaults:
        run:
          shell: ${{ matrix.sys.shell }}

    steps:
    - name: Install Haskell
      uses: input-output-hk/actions/haskell@latest
      id: setup-haskell
      with:
        ghc-version: ${{ matrix.ghc }}
        cabal-version: ${{ matrix.cabal }}

    - name: Install system dependencies
      uses: input-output-hk/actions/base@latest
      with:
        use-sodium-vrf: true

    - name: Checkout
      uses: actions/checkout@v4

    - name: Cabal update
      run: cabal update

    # A dry run `build all` operation does *NOT* download anything, it just looks at the package
    # indices to generate an install plan.
    - name: Build dry run
      run: cabal build all --enable-tests --dry-run --minimize-conflict-set

    # From the install plan a dependency list is generated here.
    - name: Windows toolchain setup
      if: runner.os == 'Windows'
      uses: msys2/setup-msys2@v2

    - name: Record dependencies (Windows)
      if: runner.os == 'Windows'
      run: cat dist-newstyle/cache/plan.json | jq -r '."install-plan"[].id' | sort | uniq > dependencies.txt

    # From the dependency list the cached dependencies is restored.
    # The hash of `dependencies.txt` is used as a part of the cache key because that will be stable
    # until the `index-state` values in the `cabal.project` file changes.
    - name: Restore cached dependencies
      uses: actions/cache/restore@v4
      id: cache
      with:
        path: |
          ${{ steps.setup-haskell.outputs.cabal-store }}
          dist-newstyle
        key: cache-${{ env.CABAL_CACHE_VERSION }}-${{ runner.os }}-${{ matrix.ghc }}-${{ hashFiles('dependencies.txt') }}

    # The dependencies are installed. If the cache is found and restored in the previous step,
    # this should be a no-op. If the cache key is not found the build assets are produced for the
    # caching in the next step.
    - name: Install dependencies
      run: cabal build all --enable-tests --only-dependencies -j --ghc-option=-j4

    # Always store the cabal cache.
    # This may benignly fail if the cache key is already populated.
    - name: Cache Cabal store
      uses: actions/cache/save@v4
      with:
        path: |
          ${{ steps.setup-haskell.outputs.cabal-store }}
          dist-newstyle
        key: cache-${{ env.CABAL_CACHE_VERSION }}-${{ runner.os }}-${{ matrix.ghc }}-${{ hashFiles('dependencies.txt') }}

    - name: Build all
      if: runner.os != 'Windows'
      run: cabal build all --enable-tests

    - name: Build Windows
      if: runner.os == 'Windows'
      id: build-step-windows
      run: |
        cabal build all
        echo "windows-output=${{ github.workspace }}\dist-newstyle\build\x86_64-windows\ghc-${{ matrix.release-ghc }}\cardano-addresses-${{ matrix.release-tag }}\x\cardano-address\build\cardano-address\cardano-address.exe" >> $GITHUB_ENV

    - name: Run tests
      env:
        TMPDIR: ${{ runner.temp }}
        TMP: ${{ runner.temp }}
        KEEP_WORKSPACE: 1
      run: cabal test all --enable-tests --test-show-details=direct

    - name: Running Haddock
      run: |
        cabal haddock

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      if: runner.os == 'Windows'
      with:
        name: cardano-address.exe
        path: ${{ env.windows-output }}
        retention-days: 1

    - name: Preparing Linux/Macos artifact
      if: runner.os != 'Windows'
      env:
        artifactFile: "cardano-address-${{ matrix.ghc }}-${{ matrix.sys.os }}"
        artifactName: "cardano-address.tar.gz"
      run: |
        mkdir artifacts

        for exe in $(cat dist-newstyle/cache/plan.json | jq -r '."install-plan"[] | select(.style == "local" and (."component-name" | startswith("exe:"))) | ."bin-file"'); do
          if [ -f $exe ]; then
            echo "Including artifact $exe"
            
            ( cd artifacts
              tar -C "$(dirname $exe)" -czf ${{ env.artifactName}} $exe
            )
          else
            echo "Skipping artifact $exe"
          fi
        done

        echo "artifactPath=artifacts/" >> $GITHUB_ENV
        echo "artifactFile=${{ env.artifactFile }}" >> $GITHUB_ENV

    - name: Upload Linux/Macos artifact
      if: runner.os != 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: "${{ env.artifactFile }}.tar.gz"
        path: ${{ env.artifactPath }}
        retention-days: 1

  release:
    name: "Release"
    if: ${{ ! startsWith(github.ref, 'refs/tags/') }}
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/download-artifact@v4

    - name: Pick artifacts to publish and change names
      run: |
        sha256sums_filename="cardano-address-${{ matrix.release-tag }}-sha256sums.txt"
        sha256sum cardano-address-*/* >> "$sha256sums_filename"

        mv cardano-address-${{ matrix.release-ghc }}-windows-latest/cardano-address.exe cardano-address-${{ matrix.release-tag }}-win64.exe
        mv cardano-address-${{ matrix.release-ghc }}-macos-latest/cardano-address.tar.gz cardano-address-${{ matrix.release-tag }}-macos.tar.gz
        mv cardano-address-${{ matrix.release-ghc }}-ubuntu-latest/cardano-address.tar.gz cardano-address-${{ matrix.release-tag }}-linux.tar.gz

    - name: Draft Release
      uses: softprops/action-gh-release@v2
      with:
        draft: true
        files: |
          cardano-address-*-win64.exe
          cardano-address-*-macos.tar.gz
          cardano-address-*-linux.tar.gz
          cardano-address-*-sha256sums.txt
