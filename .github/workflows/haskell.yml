name: Haskell CI

on:
  push:
    branches: [ "master" ]
  pull_request:

jobs:
  build:
    runs-on: ${{ matrix.sys.os }}

    strategy:
      fail-fast: false
      matrix:
        ghc: ["9.6", "9.10", "9.12"]
        cabal: ["3.14"]
        sys:
          - { os: windows-latest, shell: 'C:/msys64/usr/bin/bash.exe -e {0}' }
          - { os: ubuntu-latest, shell: bash }
        include:
          # Using include, to make sure there will only be one macOS job, even if the matrix gets expanded later on.
          # We want a single job, because macOS runners are scarce.
          - cabal: "3.12"
            ghc: "9.6"
            sys:
              os: macos-latest
              shell: bash

    defaults:
        run:
          shell: ${{ matrix.sys.shell }}

    steps:
    - name: Setting toolchain variables
      run: |
        echo "release-ghc=9.6" >> $GITHUB_ENV

    - name: Install Haskell
      uses: input-output-hk/actions/haskell@latest
      id: setup-haskell
      with:
        ghc-version: ${{ matrix.ghc }}
        cabal-version: ${{ matrix.cabal }}

    - name: Install system dependencies
      uses: input-output-hk/actions/base@latest
      with:
        use-sodium-vrf: true

    - name: Checkout
      uses: actions/checkout@v4

    - name: Cabal update
      run: cabal update

    # A dry run `build all` operation does *NOT* download anything, it just looks at the package
    # indices to generate an install plan.
    - name: Build dry run
      run: cabal build all --enable-tests --dry-run --minimize-conflict-set

    # From the install plan a dependency list is generated here.
    - name: Windows toolchain setup
      if: runner.os == 'Windows'
      uses: msys2/setup-msys2@v2

    - name: Record dependencies (Windows)
      if: runner.os == 'Windows'
      run: cat dist-newstyle/cache/plan.json | jq -r '."install-plan"[].id' | sort | uniq > dependencies.txt

    # From the dependency list the cached dependencies is restored.
    # The hash of `dependencies.txt` is used as a part of the cache key because that will be stable
    # until the `index-state` values in the `cabal.project` file changes.
    - name: Restore cached dependencies
      uses: actions/cache/restore@v4
      id: cache
      with:
        path: |
          ${{ steps.setup-haskell.outputs.cabal-store }}
          dist-newstyle
        key: cache-${{ env.CABAL_CACHE_VERSION }}-${{ runner.os }}-${{ matrix.ghc }}-${{ hashFiles('dependencies.txt') }}

    # The dependencies are installed. If the cache is found and restored in the previous step,
    # this should be a no-op. If the cache key is not found the build assets are produced for the
    # caching in the next step.
    - name: Install dependencies
      run: cabal build all --enable-tests --only-dependencies -j --ghc-option=-j4

    # Always store the cabal cache.
    # This may benignly fail if the cache key is already populated.
    - name: Cache Cabal store
      uses: actions/cache/save@v4
      with:
        path: |
          ${{ steps.setup-haskell.outputs.cabal-store }}
          dist-newstyle
        key: cache-${{ env.CABAL_CACHE_VERSION }}-${{ runner.os }}-${{ matrix.ghc }}-${{ hashFiles('dependencies.txt') }}

    - name: Build (Linux/Macos)
      if: runner.os != 'Windows'    
      run: cabal build all --enable-tests

    - name: Sign and Notarize macOS executable
      if: runner.os == 'macOS'
      uses: toitlang/action-macos-sign-notarize@v2
      with:
        certificate: ${{ secrets.APPLE_CERTIFICATE }}
        certificate-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        username: ${{ secrets.APPLE_ID_USERNAME }}
        password: ${{ secrets.APPLE_ID_PASSWORD }}
        apple-team-id: ${{ vars.APPLE_TEAM_ID }}
        app-path: '**/cardano-address'

    - name: Build Windows
      if: runner.os == 'Windows'
      run: cabal build all
 
    - name: Run tests
      env:
        TMPDIR: ${{ runner.temp }}
        TMP: ${{ runner.temp }}
        KEEP_WORKSPACE: 1
      run: cabal test all --enable-tests --test-show-details=direct

    - name: Running Haddock
      run: cabal haddock

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      if: runner.os == 'Windows'
      with:
        name: "cardano-address-${{ matrix.ghc }}-${{ matrix.sys.os }}"
        path: '**/cardano-address.exe'
        retention-days: 1

    - name: Preparing Linux/Macos artifact
      if: runner.os != 'Windows'
      env:
        artifactFile: "cardano-address-${{ matrix.ghc }}-${{ matrix.sys.os }}"
        artifactName: "cardano-address.tar.gz"
      run: |
        mkdir artifacts

        for exe in $(cat dist-newstyle/cache/plan.json | jq -r '."install-plan"[] | select(.style == "local" and (."component-name" | startswith("exe:"))) | ."bin-file"'); do
          if [ -f $exe ]; then
            echo "Including artifact $exe"
            
            ( cd artifacts
              tar -C "$(dirname $exe)" -czf ${{ env.artifactName}} $exe
            )
          else
            echo "Skipping artifact $exe"
          fi
        done

        echo "artifactPath=artifacts/" >> $GITHUB_ENV
        echo "artifactFile=${{ env.artifactFile }}" >> $GITHUB_ENV

    - name: Upload Linux/Macos artifact
      if: runner.os != 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: "${{ env.artifactFile }}"
        path: ${{ env.artifactPath }}
        retention-days: 1

  release:
    name: "Release"
    if: ${{ startsWith(github.ref, 'refs/tags') }}
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Setting Release variables
      run: |
        echo "release-ghc=9.6" >> $GITHUB_ENV
        echo "release-ghc-exact=9.6.7" >> $GITHUB_ENV        
        echo "release-tag=4.0.2" >> $GITHUB_ENV

    - uses: actions/download-artifact@v4

    - name: Pick artifacts to publish and change names
      run: |
        sha256sums_filename="cardano-address-${{ env.release-tag }}-sha256sums.txt"

        windows_exe="cardano-address-${{ env.release-ghc }}-windows-latest/dist-newstyle/build/x86_64-windows/ghc-${{ env.release-ghc-exact }}/cardano-addresses-${{ env.release-tag }}/x/cardano-address/build/cardano-address/cardano-address.exe"
        zip cardano-address-${{ env.release-tag }}-win64.zip "$windows_exe"
        
        mv cardano-address-${{ env.release-ghc }}-macos-latest/cardano-address.tar.gz cardano-address-${{ env.release-tag }}-macos.tar.gz
        mv cardano-address-${{ env.release-ghc }}-ubuntu-latest/cardano-address.tar.gz cardano-address-${{ env.release-tag }}-linux.tar.gz

        sha256sum cardano-address-${{ env.release-tag }}-win64.zip cardano-address-${{ env.release-tag }}-macos.tar.gz  cardano-address-${{ env.release-tag }}-linux.tar.gz > "$sha256sums_filename"

    - name: Checkout the repo
      uses: actions/checkout@v4

    - name: Prepare release body
      shell: bash
      run: |
        cat <<EOF >bodyConst.txt
        ## Supported Platforms

        - Linux 64-bit
        - Windows 64-bit
        - Macos 64-bit

        ## Signatures

        Name                           | Role                | Approval
        ---                            | ---                 | ---:
        Pawel Jakubas @paweljakubas        | Software Engineer |          
        EOF
        
        awk 'BEGIN{RS="## \\[4.0.2"; FS="4.0.3\\]"}NF>1{print $NF}' ${{ github.workspace }}/ChangeLog.md > bodyInfo.txt
        cat bodyInfo.txt > release-body.txt
        cat bodyConst.txt >> release-body.txt

    - name: Draft Release
      uses: softprops/action-gh-release@v2
      with:
        draft: true
        body_path: release-body.txt
        files: |
          cardano-address-${{ env.release-tag }}-win64.zip
          cardano-address-${{ env.release-tag }}-macos.tar.gz
          cardano-address-${{ env.release-tag }}-linux.tar.gz
          cardano-address-${{ env.release-tag }}-sha256sums.txt
